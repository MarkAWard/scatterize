{%- extends "base.html" %}
{% block content -%}
<div id="scatter_frame">
  <div id="scatterplot">
  </div>
  &nbsp;
</div>

<div id="scatter_controls">
  <div id="y_data">Plot on y: <select id="y_col"> </select>
  </div>
  <div id="x_data">Plot on x: <select id="x_col"> </select>
  </div>
  <div id="nuisances">
    <h3>Nuisance variables</h3>
    <ul id="nuisance_vars">
    </ul>
  </div>
</div>

<div id="stats_data">
  <div id="model_stats">
  </div>
  <div id="coef_stats">
    <div id="const_stats">
    </div>
    <div id="x_stats">
    </div>
    {% for col in g.column_names -%}
    <div id="n_{{loop.index0}}_stats"></div>
    {% endfor -%}
  </div>
</div>

<table id="raw_data">
  {% for row in g.rows -%}
  <tr>
    {% for d in row -%}
    <td>{{d}}</td>
    {% endfor -%}
  </tr>
  {% endfor -%}
</table>

<script type="text/javascript">
(function($) {
  $(document).ready(function() {
    var columns = {{ g.column_names|tojson|safe }};

    S.ss = S.single_state(
      '{{url_for("regress_js", filehash=g.filehash)}}',
      columns,
      '#x_col',
      '#y_col',
      '#nuisance_vars'
    );
    $(window).trigger("hashchange");
  });
  
  $(window).bind("hashchange", function(e) {
    console.log("Hashchange!");
    S.ss.update_controls();
    var regress_url = S.ss.get_url();
    console.log("Let's get from "+regress_url);
    $.ajax({
      'url' : regress_url,
      'success' : function(data) {
        console.log(data);
        S.data = data;
        $("#scatterplot").empty();
        var scatterplot = S.scatterplot("scatterplot", 460, 460);
        scatterplot.draw_data(data.points);
        scatterplot.regression_line(
          data.coef_result.x.b, data.coef_result.const.b, "brown");
        S.update_model_stats("#model_stats", data.model_result);
        $("#coef_stats div").empty();
        S.update_coef_stats("#x_stats", data.coef_result.x);
        S.update_coef_stats("#const_stats", data.coef_result.const);
        for (var key in data.coef_result) {
          if (key.indexOf("n_") === 0) {
            var container = $("#"+key+"_stats");
            S.update_coef_stats(container, data.coef_result[key]);
          }
        }
        var ylabel = S.ss.y_var_name();
        var nuisances = S.ss.nuisance_var_names();
        if (nuisances.length > 0) {
          ylabel = "Residualized "+ylabel;
        }
        scatterplot.add_labels(S.ss.x_var_name(), ylabel);
        scatterplot.vis.render();
      },
      'error' : function(r, str) {
        // Happens in the case of, say, a singular matrix error
        console.log("Fail");
        console.log(r);
        console.log(str);
        $('#model_stats').empty().append("<h3>Regression error</h3>");
      }
    });
  });
  
})(jQuery);
</script>
{%- endblock %}