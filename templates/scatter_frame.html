{%- extends "base.html" %}
{% block content -%}
<div id="scatter_frame">
  <div id="scatterplot">
  </div>
  <form id = "save_form" action="{{url_for('save_svg')}}" method="POST">
    <input type="hidden" name="svg_data" id="svg_data" value=""/>
    <input type="submit" value="Save plot" id="save_button" />
    <a href="" id="download_link">Download data</a>
  </form>
</div>

<div id="scatter_controls">
  <div id="y_data">Plot on y: <select id="y_col"> </select>
  </div>
  <div id="x_data">Plot on x: <select id="x_col"> </select>
  </div>
  <div id="highlighter">Highlight points by group:
    <select id="highlight_col">
      <option value=""></option>
      {% for col in g.column_names -%}
      <option value="{{loop.index0}}">{{col}}</option>
      {% endfor -%}
    </select>
  </div>
  <div id="model_type">Model type:
    <select id="model_select"> 
      <option value="OLS">OLS</option>
      <option value="RLM">Robust (Huber's T)</option>
      <option value="SR">Spearman's &rho;</option>
    </select>
  </div>
  <div id="nuisances">
    <h3>Nuisance variables</h3>
    <ul id="nuisance_vars">
    </ul>
  </div>
</div>

<div id="stats_data">
  <div id="stats">
  </div>
</div>

<table id="raw_data">
  <tr>
    {% for d in g.column_names -%}
      <td>{{d}}</td>
    {% endfor -%}
  </tr>
  {% for row in g.rows -%}
  <tr>
    {% for d in row -%}
    <td>{{d}}</td>
    {% endfor -%}
  </tr>
  {% endfor -%}
</table>

<script type="text/javascript">
var Sdata = {};
(function($) {
  $(document).ready(function() {
    Sdata.scatterplot = S2.scatterplot(
      "#scatterplot", 460, 460, 5, 10, 40, 12, 22, S2.color_scales);
    var columns = {{ g.column_names|tojson|safe }};
    
    Sdata.state_manager = S2.state_manager(
      '{{url_for("regress_js", filehash=g.filehash)}}',
      '{{url_for("regress_csv", filehash=g.filehash)}}',
      columns,
      Sdata.scatterplot,
      '#x_col',
      '#y_col',
      "#highlight_col",
      '#nuisance_vars',
      '#model_select',
      '#download_link',
      '#stats'
    );
    $(window).trigger("hashchange");
  });
  
  //$("#save_button").click(function(e) {
  //  var scatter_parent = $("#scatterplot");
  //  scatter_parent.children("svg").attr("xmlns", "http://www.w3.org/2000/svg");
  //  $("#svg_data").val(scatter_parent.html());
  //  console.log($("#svg_data"));
  //}),
  //
  $(window).bind("hashchange", function(e) {
    Sdata.state_manager.hashchange(e);
    //var regress_url = Sdata.state_manager.get_url();
    //$("#download_link").attr("href", S.ss.get_csv_url());
  
    //console.log("Let's get from "+regress_url);
    //$.ajax({
    //  'url' : regress_url,
    //  'success' : function(data) {
    //    console.log(data);
    //    S.data = data;
    //    $("#scatterplot").empty();
    //    var scatterplot = S.scatterplot("scatterplot", 460, 460, S.ss);
    //    scatterplot.draw_data(data.points);
    //    if (data.regression_line) {
    //      scatterplot.regression_line(
    //        data.regression_line.slope, data.regression_line.const, "brown");
    //    }
    //    S.update_stats_diags("#stats_diags", data.stats_diagnostics);
    //
    //    scatterplot.add_labels(data.x_label, data.y_label);
    //    scatterplot.vis.render();
    //    S.scatter_instance = scatterplot;
    //  },
    //  'error' : function(r, str) {
    //    // Happens in the case of, say, a singular matrix error
    //    console.log("Fail");
    //    console.log(r);
    //    console.log(str);
    //    $('#model_stats').empty().append("<h3>Regression error</h3>");
    //  }
    //});
  });
  
})(jQuery);
</script>
{%- endblock %}